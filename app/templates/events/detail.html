{% extends "base.html" %}
{% block content %}


{% if future %}
<div class="title-wrapper">
<h1 class="page-title">{{ event.discipline }} ‚Äì {{ event.gender }}</h1>
  {% if prediction %}
    <div class="prediction-status submitted">
      ‚úÖ je hebt een voorspelling ingediend.
    </div>
  {% else %}
    <div class="prediction-status not-submitted">
      ‚ö†Ô∏è Je hebt nog geen voorspelling ingediend.
    </div>
  {% endif %}
  <span class="countdown-timer timer"
      data-start="{{ event.start_datetime.timestamp()|float }}"
      data-now="{{ now.timestamp()|float }}"></span>
</div>
{% if not startlist_loaded %}
  <button
    type="button"
    id="load-startlist-btn"
    class="btn-submit"
    style="margin-bottom: 1rem;"
  >
    Laad offici√´le startlijst
  </button>

  <div id="startlist-status" style="margin-bottom: 1rem;"></div>
{% endif %}

<form method="POST" id="prediction-form">
    <button type="submit" class="btn-submit" id="submit-btn" disabled>
      Voorspelling indienen
    </button>
  <!-- ================= PODIUM ================= -->
  <div class="podium">
    <div class="podium-slot second">
      <div class="podium-card empty" data-position="2">Selecteer rijder</div>
    </div>

    <div class="podium-slot first">
      <div class="podium-card empty" data-position="1">Selecteer rijder</div>
    </div>

    <div class="podium-slot third">
      <div class="podium-card empty" data-position="3">Selecteer rijder</div>
    </div>
  </div>

  <!-- Hidden inputs used by backend -->
  <input type="hidden" name="rider_1" id="rider_1">
  <input type="hidden" name="rider_2" id="rider_2">
  <input type="hidden" name="rider_3" id="rider_3">

  <!-- ================= RIDER GRID ================= -->
  <div class="rider-grid">
    {% for rider in startlist %}
    <div class="rider-card" data-id="{{ rider.id }}" data-name="{{ rider.name }}">
      <div class="rider-photo">
        {% if rider.photo %}
          <img src="{{ rider.photo }}" alt="{{ rider.name }}">
        {% else %}
          <div class="photo-placeholder"></div>
        {% endif %}
      </div>
      <div class="rider-name">{{ rider.name }}
      <img src="https://live.isuresults.eu/assets/images/flags/{{ rider.country }}.svg" height="10px"></div>
      <div class="rider-buttons">
        <button type="button" class="select-btn">Kies rijder</button>
        <button type="button" class="profile-btn" onclick="openProfileModal('{{ rider.id }}')">Profiel</button>
      </div>
    </div>
    {% endfor %}
  </div>


</form>
{% else %}
<div class="title-wrapper">
<h1 class="page-title">{{ event.discipline }} ‚Äì {{ event.gender }}</h1>
  {% if event.results %}
  {% if event.results_final %}
  <h2 class="event-status final">Definitief resultaat</h2>
  {% else %}
  <h2 class="event-status provisional">Voorlopig resultaat</h2>
  {% endif %}
  {% endif %}
</div>


<div id="results-status" style="margin-bottom: 1rem;"></div>
{% if not event.results_final %}
<button
    type="button"
    id="load-results-btn"
    class="btn-submit"
    style="margin-bottom: 1rem;"
  >
    {% if results %}
      Resultaten bijwerken
    {% else %}
      Resultaat laden
    {% endif %}
</button>
{% endif %}

{% if results %}
<div class="results-container">
  {% for row in results %}
  <div class="result-card
      {% if row.position == 1 %}gold{% elif row.position == 2 %}silver{% elif row.position == 3 %}bronze{% endif %}
      {% if row.rider.id in user_rider_ids %}highlight{% endif %}
  ">
      <div class="result-position">{{ row.position }}</div>
      <div class="result-photo">
        {% if row.rider.photo %}
          <img src="{{ row.rider.photo }}"  alt="{{ row.rider.name }}">
        {% else %}
          <div class="photo-placeholder"></div>
        {% endif %}
      </div>
      <div class="time">{{ row.endtime }}</div>

      <div class="result-info">
          <div class="result-name">
            {{ row.rider.name }}
            <img src="https://live.isuresults.eu/assets/images/flags/{{ row.rider.country }}.svg" height="10px">
          </div>
          <div class="result-time">
            {{ row.end_time }}
          </div>
          {% if prediction %}
            {% if row.rider.id == prediction.rider_1_id %}
              <div class="result-points">
                {{ prediction.rider_1_score }}<br>
                <a>{{ prediction.rider_1_base }}x
                {{ prediction.rider_1_captain }}x
                {{ prediction.rider_1_rarity }}</a>
              </div>
            {% elif row.rider.id == prediction.rider_2_id %}
              <div class="result-points">
                {{ prediction.rider_2_score }}<br>
                <a>{{ prediction.rider_2_base }}x
                {{ prediction.rider_2_captain }}x
                {{ prediction.rider_2_rarity }}</a>
              </div>
            {% elif row.rider.id == prediction.rider_3_id %}
              <div class="result-points">
                {{ prediction.rider_3_score }}<br>
                <a>{{ prediction.rider_3_base }}x
                {{ prediction.rider_3_captain }}x
                {{ prediction.rider_3_rarity }}</a>
              </div>
            {% endif %}
          {% endif %}

      </div>
  </div>
  {% endfor %}
</div>
{% endif %}


{% endif %}

<!-- ================= STYLES ================= -->
<style>
/* ================= PAGE TITLE ================= */
.page-title {
  font-size: 5rem;           /* Prominent size for a main title */
  font-weight: 700;             /* Bold, strong presence */
  color: var(--color-2);        /* Dark teal for good contrast */
  margin-bottom: 2rem;          /* Clear separation from buttons/content */
  line-height: 1.2;
  text-align: left;             /* Classic left-aligned title */
  border-left: 5px solid var(--color-3); /* Optional accent bar */
  padding-left: 1rem;           /* Space between accent bar and text */
  letter-spacing: 0.5px;        /* Slightly spaced letters for elegance */
  text-transform: capitalize;   /* Capitalize discipline/gender nicely */
}

/* ================= BUTTON ================= */
#load-startlist-btn {
  background-color: var(--color-3); /* Vibrant lime green */
  color: white;
  border: none;
  padding: 0.6rem 1.4rem;
  font-size: 1rem;
  font-weight: 600;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

#load-startlist-btn:hover {
  background-color: var(--color-5); /* Slightly darker green on hover */
  transform: translateY(-2px);      /* Subtle lift effect */
  box-shadow: 0 6px 10px rgba(0,0,0,0.15);
}

#load-startlist-btn:active {
  transform: translateY(0);
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}
/* Buttons */
.btn-submit {
    background-color: #1e88e5;
    color: white;
    padding: 0.7rem 1.4rem;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;

}

.btn-submit:disabled {
    background: #aaa;
    cursor: not-allowed;
}

/* ================= PODIUM ================= */
/* ================= PODIUM ================= */
.podium {
    display: flex;
    justify-content: center;
    align-items: flex-end;
    gap: 1.5rem;
    margin: 2rem 0;
    height: 300px;

    /* NEW: background image */
    background-image: url('https://img.olympics.com/images/image/private/t_16-9_380/f_auto/primary/l3z6szynbgufcpwn56cz');
    background-size: cover;      /* cover entire div */
    background-position: center; /* center the image */
    background-repeat: no-repeat;
    padding: 2rem;               /* optional: give some padding so podium cards aren‚Äôt flush to edge */
    border-radius: 16px;         /* optional: match card style */
}
.countdown-timer {
    /* Size & Shape */
    width: 180px;
    height: 180px;
    border-radius: 50%;       /* perfect circle */
    display: flex;
    justify-content: center;   /* center content horizontally */
    align-items: center;       /* center content vertically */

    /* Typography */
    font-family: 'Montserrat', sans-serif; /* modern, clean font */
    font-weight: 700;
    font-size: 2rem;        /* large and readable */
    color: black;
    text-align: center;

    /* Background & Border */
    background: var(--alabaster-grey);
    border: 8px solid var(--color-1);

    /* Visual Effects */
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1); /* subtle depth */
    transition: transform 0.2s ease, box-shadow 0.2s ease;

    /* Optional padding for future inner content */
    padding: 10px;
}

/* Hover animation for subtle interactivity */
.countdown-timer:hover {
    transform: scale(1.05);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
}


.podium-slot {
    width: 170px;
    text-align: center;
}

.podium-slot.first {
    transform: translateY(-25px);
}

.podium-card {
    background: var(--color-6);
    border-radius: 14px;
    padding: 1rem;
    min-height: 180px;
    box-shadow: 0 6px 16px rgba(0,0,0,0.12);
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    align-items: center;
    color: var(--color-1);
}

.podium-card.empty {
    color: #999;
    font-style: italic;
    justify-content: center;
}

.podium-card.dragging {
    opacity: 0.4;
}

.podium-card.drag-over {
    outline: 2px dashed #1e88e5;
}

/* ===== PODIUM MEDAL COLORS ===== */
.podium-card.gold {
    border: 7px solid #ffd700;
    background: linear-gradient(135deg, #ffd700, #fff);
}

.podium-card.silver {
    border: 7px solid #c0c0c0;
    background: linear-gradient(135deg, #c0c0c0, #fff);
}

.podium-card.bronze {
    border: 7px solid #cd7f32;
    background: linear-gradient(135deg, #cd7f32, #fff);
}

.podium-card img {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    object-fit: cover;
    margin-bottom: 0.5rem;
}

.podium-card strong {
    font-size: 1.05rem;
}

.remove-btn {
    border: none;
    background: none;
    color: #d32f2f;
    font-weight: 700;
    cursor: pointer;
}

/* ================= RIDER GRID ================= */
.rider-grid {
  display: grid;
  grid-template-columns: repeat(6, 1fr);
  gap: 1rem;
  margin-bottom: 2rem;
}

.rider-card {
  background: var(--color-2);
  border-radius: 16px;
  padding: 1rem;
  text-align: center;
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0.5rem;
  transition: transform 0.2s;
}
.rider-card.selected {
  position: relative;
  /* dark semi-transparent overlay */
  background-color: var(--color-2);
  opacity: 0.4;
  color: #fff;
}

/* Optional: overlay icon or text */
.rider-card.selected::after {
  content: "Selected";
  position: absolute;
  top: 5px;
  right: 5px;
  background: rgba(255,255,255,0.9);
  padding: 2px 6px;
  border-radius: 4px;
  font-size: 0.75rem;
  font-weight: 700;
  color: var(--color-4);
}

.rider-card:hover {
  transform: translateY(-10px);
  background-color: var(--color-5);
}

.rider-photo img {
  width: 90px;
  height: 90px;
  border-radius: 50%;
  object-fit: cover;
  border: 3px solid #1e88e5;
}

.rider-name {
  font-weight: 600;
  font-size: 0.9rem;
  text-align: center;
  color: var(--color-1);

}

.rider-buttons {
  display: flex;
  justify-content: center;
  gap: 0.3rem;
  margin-top: auto;
  flex-wrap: wrap;
}

.select-btn {
  background: var(--color-6);
  color: white;
  border: none;
  padding: 0.35rem 0.6rem;
  border-radius: 6px;
  cursor: pointer;
  font-size: 0.85rem;
}

.select-btn:disabled {
  background: #aaa;
  cursor: not-allowed;
}

.profile-btn {
  background: var(--color-3);
  color: white;
  border: none;
  padding: 0.35rem 0.6rem;
  border-radius: 6px;
  cursor: pointer;
  font-size: 0.85rem;
}

.profile-btn:hover {
  background: #388e3c;
}

/* ===== MODAL ===== */
.modal {
  display: none; /* hidden by default */
  position: fixed;
  inset: 0; /* top:0; right:0; bottom:0; left:0 */
  z-index: 1000;
  background-color: rgba(0,0,0,0.6);
  justify-content: center;
  align-items: center;
}

.modal-content {
  width: 95%;        /* almost full width */
  height: 95%;       /* almost full height */
  max-width: 1200px; /* optional max width for big screens */
  max-height: 1000px; /* optional max height */
  background-color: #fff;
  border-radius: 12px;
  display: flex;
  flex-direction: column;
  padding: 1rem;
  box-shadow: 0 4px 20px rgba(0,0,0,0.2);
}

#profile-frame {
  flex-grow: 1;
  width: 100%;
  border: none;
  border-radius: 8px;
}

.modal-close {
  align-self: flex-end;
  font-size: 1.5rem;
  font-weight: bold;
  cursor: pointer;
}


/* ===== RESULTS CONTAINER ===== */
.results-container {
    display: grid;
    gap: 1rem;
    max-width: 1200px;
    grid-template-columns: repeat(2, 1fr); /* two columns */
    margin: 0 auto;    /* horizontally center the container */
}


/* ===== RESULT CARD ===== */
.result-card {
    min-width:100%;
    height:100px;
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 0.75rem 1rem;
    border-radius: 25px;
    background: var(--alabaster-grey);
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    transition: transform 0.2s, box-shadow 0.2s;
    border-left: 25px solid var(--color-6);
}

.result-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 16px rgba(0,0,0,0.12);
    border-left: 25px solid var(--color-1);
}

/* ===== POSITION ===== */
.result-position {
    font-size: 1.2rem;
    font-weight: 700;
    width: 2rem;
    text-align: center;
    color: black;
}

/* ===== RIDER PHOTO ===== */
.result-photo img {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    object-fit: cover;
    border: 5px solid var(--color-1);
}

.photo-placeholder {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: #ccc;
}

/* ===== RIDER INFO ===== */
.result-info {
    display: flex;
    flex-direction: column;
}

.result-name {
    font-weight: 600;
    font-size: 1rem;
    color: var(--medium-jungle);
}
.result-time {
  color: var(--black);
 }

.result-info {
    display: flex;
    flex-direction: column;
    flex-grow: 1;
    position: relative;
}
/* Points box for highlighted riders */
.result-points {
    position: absolute;
    right: 0;
    top: 50%;
    transform: translateY(-50%);
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--color-4);
    border: 2px solid #1e88e5;
    border-radius:30px;
    padding: 0.3rem 0.6rem;
    background: var(--alabaster-grey);
    text-align: center;
    width: 90px;
    height:90px
}

.result-points a {
  font-size:0.7rem;
  color: var(--color-1);
}
/* Hide points for non-highlighted riders */
.result-card:not(.highlight) .result-points {
    display: none;
}

/* Adjust for small screens */
@media (max-width: 600px) {
    .result-points {
        font-size: 1rem;
        padding: 0.2rem 0.5rem;
        min-width: 50px;
    }
}

/* ===== MEDAL COLORS ===== */
.result-card.gold { border-left: 25px solid #ffd700; }
.result-card.silver { border-left: 25px solid #c0c0c0; }
.result-card.bronze { border-left: 25px solid #cd7f32; }

/* ===== HIGHLIGHT USER PICK ===== */
.result-card.highlight {
    background-color: var(--powder-blue);
}

/* RESPONSIVE */
@media (max-width: 600px) {
    .results-container {
        gap: 0.75rem;
    }
    .result-card {
        gap: 0.5rem;
        padding: 0.5rem 0.75rem;
    }
    .result-photo img, .photo-placeholder {
        width: 50px;
        height: 50px;
    }
    .result-position {
        font-size: 1rem;
        width: 1.5rem;
        color: black;
    }
}
/* ================= PRIMARY SUBMIT BUTTON ================= */
#submit-btn {
  background-color: var(--color-3);  /* Vibrant lime green for primary action */
  color: white;
  border: none;
  padding: 0.7rem 1.6rem;            /* Comfortable size */
  font-size: 1rem;
  font-weight: 600;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

/* Hover effect when enabled */
#submit-btn:not(:disabled):hover {
  background-color: var(--color-5); /* Slightly darker green on hover */
  transform: translateY(-2px);       /* Subtle lift */
  box-shadow: 0 6px 10px rgba(0,0,0,0.15);
}

/* Active effect */
#submit-btn:not(:disabled):active {
  transform: translateY(0);
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

/* Disabled state */
#submit-btn:disabled {
  background-color: #c5c5c5;         /* Soft gray for disabled */
  color: #f0f0f0;                    /* Light text for readability */
  cursor: not-allowed;
  box-shadow: none;
  transform: none;
}

  body {
    margin: 0;
    min-height: 100vh;

    background:
        /* soft curved light streaks */
        linear-gradient(
            140deg,
            transparent 35%,
            rgba(255,255,255,0.18) 42%,
            transparent 50%
        ),
        linear-gradient(
            300deg,
            transparent 30%,
            rgba(200,255,255,0.12) 38%,
            transparent 45%
        ),

        /* neon lime bloom */
        radial-gradient(
            55% 45% at 65% 55%,
            rgba(150, 255, 130, 0.38),
            transparent 68%
        ),

        /* aqua sweep */
        radial-gradient(
            65% 40% at 30% 65%,
            rgba(70, 210, 220, 0.5),
            transparent 72%
        ),

        /* deep base ocean */
        linear-gradient(
            160deg,
            #063f4a 0%,
            #075f66 35%,
            #0a7b74 60%,
            #1a8b5a 100%
        );

    background-attachment: fixed;
    background-blend-mode: screen, screen, lighten, lighten, normal;
}

body::before {
    content: "";
    position: fixed;
    inset: 0;
    pointer-events: none;

    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='160' height='160'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.6' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='160' height='160' filter='url(%23n)' opacity='0.07'/%3E%3C/svg%3E");

    mix-blend-mode: soft-light;
    opacity: 0.25;
}
.prediction-status {
  margin-bottom: 1.5rem;
  font-weight: 600;
  padding: 0.5rem 1rem;
  border-radius: 8px;
  display: inline-block;
}

.prediction-status.submitted {
  background-color: #dcedc8; /* light green */
  color: #33691e;
}

.prediction-status.not-submitted {
  background-color: #fff3e0; /* light orange */
  color: #e65100;
}
.podium-arrows {
  display: flex;
  gap: 1rem;
  margin-top: 0.4rem;
  height:25px;
  justify-content:center;
}

.arrow-btn {
  border: solid 1px var(--color-1);
  background: var(--color-2);
  border-radius: 15px;
  padding: 0.2rem 0.4rem;
  cursor: pointer;
}

.title-wrapper {
  display: flex;               /* use flex layout */
  justify-content: space-between; /* space between title and status */
  align-items: center;         /* vertically center them */
  width: 100%;
  gap: 1rem;                   /* optional spacing between items */
  flex-wrap: wrap;             /* allow wrapping on small screens */
}
h2.event-status {
  font-size: 1rem;          /* prominent but smaller than main title */
  font-weight: 700;
  padding: 0.5rem 1rem;
  border-radius: 8px;
  display: inline-block;
}

/* Final result */
h2.event-status.final {
  background-color: var(--mint-leaf); /* bright, positive green */
  color: var(--dark-teal-2);
  border: 2px solid var(--medium-jungle);
}

/* Provisional / not final */
h2.event-status.provisional {
  background-color: var(--golden-sand); /* soft amber/orange */
  color: var(--dark-teal);
  border: 2px solid var(--stormy-teal);
}

@media (max-width: 768px) {
  .rider-grid {
    grid-template-columns: repeat(2, 1fr);
  }
}

</style>
<style>
/* Subtle warning for podium cards not matching prediction */
.podium-card.warning {
  border: 2px solid #fbc02d; /* amber border */
  background-color: #fff8e1;  /* very light yellow background */
  position: relative;
}

/* Warning text inside the podium card */
.podium-card .warning-text {
  font-size: 0.8rem;
  color: #f57c00;  /* orange text */
  font-weight: 600;
  margin-top: 0.5rem;
  text-align: center;
}

</style>


<script>
document.addEventListener("DOMContentLoaded", () => {

  const selected = [];
  const submitBtn = document.getElementById("submit-btn");

  const podiumCards = {
    1: document.querySelector('.podium-card[data-position="1"]'),
    2: document.querySelector('.podium-card[data-position="2"]'),
    3: document.querySelector('.podium-card[data-position="3"]'),
  };

  function updateHiddenInputs() {
    document.getElementById('rider_1').value = selected[0] || '';
    document.getElementById('rider_2').value = selected[1] || '';
    document.getElementById('rider_3').value = selected[2] || '';
    submitBtn.disabled = selected.length !== 3;
  }

  function renderPodium() {
    const medalClass = {1: 'gold', 2: 'silver', 3: 'bronze'};

    [1, 2, 3].forEach(pos => {
      const card = podiumCards[pos];
      const riderId = selected[pos - 1];

      card.className = 'podium-card'; // reset
      if (!riderId) {
        card.classList.add('empty');
        card.innerHTML = 'Select rider';
        return;
      }

      const arrows = `
        <div class="podium-arrows">
          ${pos > 1 ? `<button type="button" class="arrow-btn up" data-pos="${pos}">‚¨Ü</button>` : ``}
          ${pos < 3 ? `<button type="button" class="arrow-btn down" data-pos="${pos}">‚¨á</button>` : ``}
        </div>
      `;

      const riderCard = document.querySelector(`.rider-card[data-id="${riderId}"]`);
      if (!riderCard) return;

      const imgSrc = riderCard.querySelector('img') ? riderCard.querySelector('img').src : '';

      // --- NEW WARNING LOGIC ---
      let warningHTML = '';
      {% if prediction %}
        const correctPrediction = [
          "{{ prediction.rider_1_id }}",
          "{{ prediction.rider_2_id }}",
          "{{ prediction.rider_3_id }}"
        ];
        if (riderId !== correctPrediction[pos - 1]) {
          card.classList.add('warning'); // amber border
          warningHTML = `<div class="warning-text">‚ö†Ô∏è Wijziging niet opgeslagen</div>`;
        } else {
          card.classList.remove('warning');
        }
      {% endif %}
      // ------------------------

      card.classList.add({1:'gold',2:'silver',3:'bronze'}[pos]);
      card.setAttribute('draggable','true');
      card.dataset.riderId = riderId;

      // Build innerHTML including warning
      card.innerHTML = `
        ${imgSrc ? `<img src="${imgSrc}" alt="${riderCard.dataset.name}">` : ''}
        <strong>${riderCard.dataset.name}</strong>
        ${warningHTML}
        <div class="podium-controls" style="display:flex; justify-content:center; gap:0.3rem; align-items:center; margin-top:0.5rem;">
          ${pos > 1 ? `<button type="button" class="arrow-btn up" data-pos="${pos}">‚¨Ü</button>` : `<div style="width:26px"></div>`}
          <button type="button" class="profile-btn" onclick="openProfileModal('${riderId}')">Profile</button>
          ${pos < 3 ? `<button type="button" class="arrow-btn down" data-pos="${pos}">‚¨á</button>` : `<div style="width:26px"></div>`}
        </div>
        <button type="button" class="remove-btn" data-id="${riderId}" style="margin-top:0.5rem;">‚úï Verwijder</button>
      `;
    });





    // Disable select buttons
    document.querySelectorAll('.select-btn').forEach(btn => {
      const id = btn.closest('.rider-card').dataset.id;
      btn.disabled = selected.includes(id);
    });

    // Visual selection state
    document.querySelectorAll('.rider-card').forEach(card => {
      const id = card.dataset.id;
      card.classList.toggle('selected', selected.includes(id));
    });

    updateHiddenInputs();
    enableDragAndDrop();

    // ‚úÖ NEW: highlight mismatch with prediction
    highlightPredictionMismatch();
  }


  // Select rider
  document.querySelectorAll('.select-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      if (selected.length >= 3) return;
      const id = btn.closest('.rider-card').dataset.id;
      selected.push(id);
      renderPodium();
    });
  });

  const profileModal = document.getElementById("profile-modal");
  const profileFrame = document.getElementById("profile-frame");
  const modalClose = profileModal.querySelector(".modal-close");

  window.openProfileModal = function(riderId) {
    const url = `https://live.isuresults.eu/profiles/${riderId}`;
    console.log("Profile URL:", url);   // üëà print it
    profileFrame.src = url;
    profileModal.style.display = "flex";
  }

  modalClose.addEventListener("click", () => {
      profileModal.style.display = "none";
      profileFrame.src = "";
  });

  window.addEventListener("click", (e) => {
      if (e.target === profileModal) {
          profileModal.style.display = "none";
          profileFrame.src = "";
      }
  });




  // Remove rider
  document.addEventListener('click', e => {
    if (!e.target.classList.contains('remove-btn')) return;
    const id = e.target.dataset.id;
    const index = selected.indexOf(id);
    if (index !== -1) {
      selected.splice(index, 1);
      renderPodium();
    }
  });

  // Arrow up/down
  document.addEventListener('click', e => {
    if (!e.target.classList.contains('arrow-btn')) return;

    const pos = parseInt(e.target.dataset.pos, 10) - 1;

    if (e.target.classList.contains('up') && pos > 0) {
      [selected[pos - 1], selected[pos]] = [selected[pos], selected[pos - 1]];
    }

    if (e.target.classList.contains('down') && pos < selected.length - 1) {
      [selected[pos + 1], selected[pos]] = [selected[pos], selected[pos + 1]];
    }

    renderPodium();
  });

  function enableDragAndDrop() {
    let draggedIndex = null;

    Object.values(podiumCards).forEach((card, index) => {
      card.addEventListener('dragstart', () => {
        draggedIndex = index;
        card.classList.add('dragging');
      });

      card.addEventListener('dragend', () => {
        card.classList.remove('dragging');
        draggedIndex = null;
      });

      card.addEventListener('dragover', e => {
        e.preventDefault();
        card.classList.add('drag-over');
      });

      card.addEventListener('dragleave', () => {
        card.classList.remove('drag-over');
      });

      card.addEventListener('drop', () => {
        card.classList.remove('drag-over');
        if (draggedIndex === null || draggedIndex === index) return;

        const moved = selected.splice(draggedIndex, 1)[0];
        selected.splice(index, 0, moved);
        renderPodium();
      });
    });
  }

  {% if prediction %}
    selected.push(
      "{{ prediction.rider_1_id }}",
      "{{ prediction.rider_2_id }}",
      "{{ prediction.rider_3_id }}"
    );
    renderPodium();
  {% endif %}

});
</script>
<script>
const loadBtn = document.getElementById("load-startlist-btn");

if (loadBtn) {
  loadBtn.addEventListener("click", async () => {
    loadBtn.disabled = true;
    loadBtn.textContent = "Loading startlist‚Ä¶";

    const res = await fetch(
      "{{ url_for('events.load_startlist', event_id=event.id) }}",
      { method: "POST" }
    );

    const data = await res.json();
    const statusEl = document.getElementById("startlist-status");

    if (data.status === "loaded") {
      statusEl.textContent = "‚úÖ Startlijst geladen. Reloading‚Ä¶";
      setTimeout(() => location.reload(), 1000);
    } else if (data.status === "not_available") {
      statusEl.textContent = "‚ö†Ô∏è Startlijst nog niet beschikbaar.";
      loadBtn.disabled = false;
      loadBtn.textContent = "Load official startlist";
    } else if (data.status === "already_loaded") {
      statusEl.textContent = "‚ÑπÔ∏è Startlijst al geladen.";
    }
  });
}
</script>
<script>
const loadResultsBtn = document.getElementById("load-results-btn");

if (loadResultsBtn) {
  loadResultsBtn.addEventListener("click", async () => {
    loadResultsBtn.disabled = true;
    loadResultsBtn.textContent = "Loading results‚Ä¶";

    const res = await fetch(
      "{{ url_for('events.load_results', event_id=event.id) }}",
      { method: "POST" }
    );

    const data = await res.json();
    const statusEl = document.getElementById("results-status");

    if (data.status === "loaded_final") {
      // Final results, hide button
      statusEl.textContent = "‚úÖ Definitieve resultaat geladen.";
      loadResultsBtn.style.display = "none";
      setTimeout(() => location.reload(), 1000);
    } else if (data.status === "loaded_partial") {
      // Partial results, update button text
      statusEl.textContent = "‚ö†Ô∏è Results are not final yet.";
      loadResultsBtn.disabled = false;
      loadResultsBtn.textContent = "Resultaten bijwerken";
      setTimeout(() => location.reload(), 1000);
    } else if (data.status === "not_available") {
      statusEl.textContent = "‚ö†Ô∏è Resultaten nog niet beschikbaar.";
      loadResultsBtn.disabled = false;
      loadResultsBtn.textContent = "Officieel resultaat laden";
    } else if (data.status === "already_loaded") {
      if (data.final) {
        statusEl.textContent = "‚úÖ Resultaat al geladen.";
        loadResultsBtn.style.display = "none";
      } else {
        statusEl.textContent = "‚ö†Ô∏è Partial results already loaded.";
        loadResultsBtn.disabled = false;
        loadResultsBtn.textContent = "Resultaten bijwerken";
      }
    }
  });
}
</script>

<script>
function highlightPredictionMismatch() {
  {% if prediction %}
    const correctPrediction = [
      "{{ prediction.rider_1_id }}",
      "{{ prediction.rider_2_id }}",
      "{{ prediction.rider_3_id }}"
    ];

    [1,2,3].forEach(pos => {
      const card = document.querySelector(`.podium-card[data-position="${pos}"]`);
      const currentRider = selected[pos - 1];

      if (!card || !currentRider) return;

      // Remove previous warning class
      card.classList.remove('warning');

      // If the current rider is not the correct one for this position
      if (currentRider !== correctPrediction[pos - 1]) {
        card.classList.add('warning');

        // Add warning text
        if (!card.querySelector('.warning-text')) {
          const warningDiv = document.createElement('div');
          warningDiv.className = 'warning-text';
          warningDiv.textContent = "‚ö†Ô∏è Afwijking van je voorspelling";
          card.appendChild(warningDiv);
        }
      } else {
        card.classList.remove('warning');
        const existing = card.querySelector('.warning-text');
        if (existing) existing.remove();
      }

    });
  {% endif %}
}
</script>
<script>
function initTimers() {
    const timers = document.querySelectorAll('.timer');

    timers.forEach(timerEl => {
        const startTime = new Date(parseFloat(timerEl.dataset.start) * 1000);
        let currentTime = new Date(parseFloat(timerEl.dataset.now) * 1000);

        function updateTimer() {
            let diff = startTime - currentTime;

            if (diff <= 0) {
                timerEl.textContent = "Evenement gestart!";
                return;
            }

            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            diff -= days * 1000 * 60 * 60 * 24;
            const hours = Math.floor(diff / (1000 * 60 * 60));
            diff -= hours * 1000 * 60 * 60;
            const minutes = Math.floor(diff / (1000 * 60));
            diff -= minutes * 1000 * 60;
            const seconds = Math.floor(diff / 1000);

            timerEl.textContent =
                (days > 0 ? days + "d " : "") +
                (hours < 10 ? "0" : "") + hours + "u " +
                (minutes < 10 ? "0" : "") + minutes + "m " +
                (seconds < 10 ? "0" : "") + seconds + "s";

            currentTime = new Date(currentTime.getTime() + 1000);
        }

        updateTimer();
        setInterval(updateTimer, 1000);
    });
}

document.addEventListener("DOMContentLoaded", initTimers);
</script>

<!-- ================= PROFILE MODAL ================= -->
<div id="profile-modal" class="modal">
  <div class="modal-content">
    <span class="modal-close">&times;</span>
    <iframe id="profile-frame" src="" frameborder="0"></iframe>
  </div>
</div>

{% endblock %}
