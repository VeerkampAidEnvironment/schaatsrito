    {% extends "base.html" %}
    {% block content %}

    <!-- Link your CSS palette -->

    <div style="display:flex; justify-content:space-between; align-items:center;">
        <a href="{{ url_for('admin.update_scores') }}"
           class="update-btn"
           onclick="return confirm('Alle scores (opnieuw) berekenen');">
            üîÑ Scores updaten
        </a>
    </div>

    <!-- ================= TOGGLE ================= -->
    <div class="toggle-container">
    <div class="toggle-switch">
      <input type="checkbox" id="viewToggle" />
      <label for="viewToggle">
        <span class="toggle-option toggle-ranking">üèÜ Ranglijst</span>
        <span class="toggle-option toggle-table">üìä Scores per afstand</span>
      </label>
    </div>
    </div>

    <!-- ================= RANKING VIEW ================= -->
    <!-- ================= RANKING VIEW ================= -->
    <div id="rankingView">

        <!-- ===== PODIUM (TOP 3) ===== -->
<div class="podium-wrapper">
    {% set first = user_scores[0] %}
    {% set second = user_scores[1] %}
    {% set third = user_scores[2] %}

    <div class="podium-spotlight"></div>

    <div class="podium podium-animate">

        <!-- ü•à SECOND -->
        <div class="podium-spot second">
            <div class="podium-block">
            <div class="podium-card">
                <div class="podium-name">{{ second.username }}</div>
                <div class="podium-score">{{ second.total_score }} pts</div>
            </div>
            <div class="medal silver">ü•à</div>
            </div>
        </div>

        <!-- ü•á FIRST -->
        <div class="podium-spot first">
            <div class="podium-block">
            <div class="podium-card winner">
                <div class="podium-name">{{ first.username }}</div>
                <div class="podium-score">{{ first.total_score }} pts</div>
            </div>
            <div class="medal gold">ü•á</div>
            </div>
        </div>

        <!-- ü•â THIRD -->
        <div class="podium-spot third">
            <div class="podium-block">
            <div class="podium-card">
                <div class="podium-name">{{ third.username }}</div>
                <div class="podium-score">{{ third.total_score }} pts</div>
            </div>
            <div class="medal bronze">ü•â</div>
            </div>
        </div>

    </div>
</div>


        <!-- ===== REGULAR RANKING (4+) ===== -->
        <div class="ranking-container">
            {% for user in user_scores[3:] %}
            <div class="ranking-card rank-{{ loop.index + 3 }}">
                <div class="rank-position">{{ loop.index + 3 }}</div>

                <div class="rank-info">
                    <div class="rank-name">{{ user.username }}</div>
                    <div class="rank-score">{{ user.total_score }} pts</div>
                </div>
            </div>
            {% endfor %}
        </div>

    </div>


    <!-- ================= FULL SCORE TABLE ================= -->
    <div id="tableView" style="display:none">
    <div class="table-card">
    <table class="leaderboard">
        <thead>
            <tr>
                <th>Gebruiker</th>
                <th>Totaal</th>
                {% for event in events %}
                    <th>{{ event.name }}</th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for user in user_scores %}
            <tr>
                <td class="user-cell">{{ user.username }}</td>
                <td class="total-cell">{{ user.total_score }}</td>

                {% for event in events %}
                <td class="score-cell"
                    data-user-id="{{ user.id }}"
                    data-event-id="{{ event.id }}"
                    data-user="{{ user.username }}"
                    data-event="{{ event.name }}"
                    data-score="{{ user_event_scores[user.id][event.id] }}">
                    {{ user_event_scores[user.id][event.id] }}
                </td>
                {% endfor %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
    </div>
    </div>

    <!-- ================= MODAL ================= -->
    <div id="scoreModal" class="modal">
      <div class="modal-content">
        <span class="modal-close">&times;</span>
        <h2 id="modalTitle"></h2>

        <table class="modal-table">
            <thead>
                <tr>
                    <th colspan="3">Voorspelling</th>
                    <th colspan="3">Jouw voorspelling</th>
                </tr>
                <tr>
                    <th>Rijder</th>
                    <th>Klassering</th>
                    <th>Punten</th>
                    <th>Rijder</th>
                    <th>Klassering</th>
                    <th>Punten</th>
                </tr>
            </thead>
            <tbody id="modalBody"></tbody>
        </table>
      </div>
    </div>

    <!-- ================= STYLES ================= -->
    <style>
    /* Page Title */
    .page-title {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 1rem;
        color: var(--color-1);
    }

    /* Toggle Buttons */
    .view-toggle {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 2rem;
    }

    .toggle-btn {
        padding: 0.6rem 1.2rem;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        font-weight: 600;
        background: var(--color-2);
        color: var(--color-4);
        transition: all 0.2s ease;
    }

    .toggle-btn.active {
        background: var(--color-3);
        color: white;
    }

    /* Ranking */
    .ranking-container {
        max-width: 600px;
        margin: 0 auto;
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }


    .ranking-card {
        display: flex;
        align-items: center;       /* vertically center */
        justify-content: space-between; /* spread children horizontally */
        background: var(--color-2);
        border-radius: 14px;
        padding: 1rem 1.5rem;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        border: 5px solid var(--bright-fern);
        gap: 1rem;                 /* optional spacing between items */
    }

    .ranking-card:hover {
        transform: translateY(-2px);
    }

    .rank-position {
        font-size: 1.8rem;
        font-weight: 800;
        width: 50px;
        height: 50px;
        display: flex;           /* flex to center text */
        align-items: center;     /* vertical center */
        justify-content: center; /* horizontal center */
        border: solid 2px var(--color-1);
        color: var(--color-1);
        border-radius: 50%;
    }


    .rank-1 .rank-position { color: #FFD700; border: solid 5px #FFD700;
    } /* Gold */
    .rank-2 .rank-position { color: #C0C0C0; border: solid 5px #C0C0C0;
    } /* Silver */
    .rank-3 .rank-position { color: #CD7F32; border: solid 5px #CD7F32;
    } /* Bronze */

    .rank-info {
        display: flex;
        flex-grow: 1;             /* takes remaining space */
        justify-content: space-between; /* push name left, score right */
        align-items: center;
        gap: 1rem;                /* optional spacing */
    }


    .rank-name {
        font-weight: 600;
        color: var(--color-5);
        padding: 0.4rem 0.8rem;
        border: solid 2px var(--color-1);
        border-radius: 20px;
        font-size: 1.2rem;
        white-space: nowrap;      /* prevent wrapping */
    }


    .rank-score {
        font-size: 1.8rem;
        font-weight: 700;
        color: var(--color-6);
    }

 /* ================= PROFESSIONAL TABLE ================= */

#tableView {
    max-width: 1200px;
    margin: 0 auto;
}

/* Card container feel */
.leaderboard {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    background: rgba(255,255,255,0.85);
    border-radius: 16px;
    overflow: hidden;
    box-shadow:
        0 10px 25px rgba(0,0,0,0.08),
        inset 0 1px 0 rgba(255,255,255,0.6);
    backdrop-filter: blur(6px);
}

/* Header */
.leaderboard thead th {
    position: sticky;
    top: 0;
    z-index: 2;

    background: linear-gradient(
        180deg,
        var(--color-1),
        var(--stormy-teal)
    );
    color: white;

    font-weight: 700;
    font-size: 0.9rem;
    letter-spacing: 0.04em;
    text-transform: uppercase;

    padding: 0.9rem 0.8rem;
    border: none;
}

/* Cells */
.leaderboard td {
    padding: 0.85rem 0.8rem;
    border-bottom: 1px solid rgba(0,0,0,0.06);
    font-size: 0.95rem;
    transition: background 0.15s ease, transform 0.08s ease;
}

/* Zebra striping */
.leaderboard tbody tr:nth-child(even) {
    background: rgba(0,0,0,0.02);
}

/* Row hover */
.leaderboard tbody tr:hover {
    background: rgba(108, 194, 57, 0.12);
}

/* User column */
.user-cell {
    font-weight: 700;
    color: var(--color-4);
    text-align: left;
    white-space: nowrap;
}

/* Total column */
.total-cell {
    font-size: 2rem;
    font-weight: 800;
    color: var(--color-1);
    background: linear-gradient(
        135deg,
        rgba(196,197,90,0.5),
        rgba(181,212,180,0.5)
    );
}

/* Score cells (clickable) */
.score-cell {
    cursor: pointer;
    font-weight: 600;
    border-radius: 6px;
    position: relative;
}

/* Hover highlight */
.score-cell:hover {
    background: var(--color-2);
    transform: scale(1.05);
}

/* Click hint dot */
.score-cell::after {
    content: "‚Üó";
    position: absolute;
    right: 6px;
    top: 4px;
    font-size: 1rem;
    opacity: 0.35;
}

.leaderboard thead th {
    border: solid 1px var(--color-4);
}

/* Rounded corners */
.leaderboard thead th:first-child {
    border-top-left-radius: 16px;
}

.leaderboard thead th:last-child {
    border-top-right-radius: 16px;
}

/* Responsive improvements */
@media (max-width: 900px) {
    .leaderboard {
        font-size: 0.85rem;
    }

    .total-cell {
        font-size: 1.1rem;
    }
}


.table-card {
    padding: 2rem;
    border-radius: 20px;
    background: rgba(255,255,255,0.35);
    backdrop-filter: blur(8px);
    border: 3px solid rgba(255,255,255,0.4);
    width:120%;
}


/* ================= EVENT WINNER HIGHLIGHT ================= */

.score-cell.event-winner {
    background: linear-gradient(
        135deg,
        var(--bright-fern),
        var(--color-3)
    );
    color: var(--dark-teal);
    font-weight: 800;
    box-shadow:
        inset 0 0 0 2px rgba(255,255,255,0.6),
        0 4px 10px rgba(0,0,0,0.15);
}

/* Small crown indicator */
.score-cell.event-winner::before {
    content: "ü•á";
    position: absolute;
    top: -4px;
    left: -1px;
    font-size: 1rem;
}

    /* Modal */
    .modal {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.6);
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }

    .modal-content {
        background: var(--color-2);
        padding: 1.5rem;
        border-radius: 12px;
        width: 90%;
        max-width: 600px;
    }

    .modal-close {
        float: right;
        font-size: 1.4rem;
        cursor: pointer;
    }

    .modal-table {
        width: 100%;
        margin-top: 1rem;
        border-collapse: collapse;
    }

    .modal-table th,
    .modal-table td {
        border: 1px solid #ddd;
        padding: 8px;
    }

        .update-btn {
        padding: 0.6rem 1.2rem;
        border-radius: 8px;
        background: var(--color-6);
        color: white;
        font-weight: 600;
        text-decoration: none;
        transition: background 0.2s ease;
    }

    .update-btn:hover {
        background: var(--color-5);
    }

    .toggle-container {
        display: flex;
        justify-content: center;  /* horizontally center */
        margin-bottom: 2rem;     /* spacing from leaderboard */
    }

    .toggle-switch {
        width: 40%;
        position: relative;
        user-select: none;
        margin-bottom: 2rem;
    }

    .toggle-switch input {
        display: none;
    }

    .toggle-switch label {
        display: flex;
        background: var(--alabaster-grey);
        border-radius: 30px;
        border: 5px solid var(--color-1);
        padding: 5px;
        cursor: pointer;
        position: relative;
    }

    .toggle-switch .toggle-option {
        flex: 1;
        text-align: center;
        font-weight: 600;
        z-index: 2;
        color: var(--color-4);
        transition: color 0.2s;
        padding: 8px 0;
    }

    .toggle-switch input:checked + label .toggle-ranking {
        color: var(--color-4);
    }

    .toggle-switch input:checked + label .toggle-table {
        color: white;
    }

    .toggle-switch label::before {
        content: "";
        position: absolute;
        width: 50%;
        height: 100%;
        background: var(--powder-blue);
        border-radius: 30px;
        top: 0;
        left: 0;
        transition: all 0.3s ease;
        z-index: 1;
    }

    .toggle-switch input:checked + label::before {
        left: 50%;
    }
      body {
        margin: 0;
        min-height: 100vh;

        background:
            /* soft curved light streaks */
            linear-gradient(
                140deg,
                transparent 35%,
                rgba(255,255,255,0.18) 42%,
                transparent 50%
            ),
            linear-gradient(
                300deg,
                transparent 30%,
                rgba(200,255,255,0.12) 38%,
                transparent 45%
            ),

            /* neon lime bloom */
            radial-gradient(
                55% 45% at 65% 55%,
                rgba(150, 255, 130, 0.38),
                transparent 68%
            ),

            /* aqua sweep */
            radial-gradient(
                65% 40% at 30% 65%,
                rgba(70, 210, 220, 0.5),
                transparent 72%
            ),

            /* deep base ocean */
            linear-gradient(
                160deg,
                #063f4a 0%,
                #075f66 35%,
                #0a7b74 60%,
                #1a8b5a 100%
            );

        background-attachment: fixed;
        background-blend-mode: screen, screen, lighten, lighten, normal;
    }

    body::before {
        content: "";
        position: fixed;
        inset: 0;
        pointer-events: none;

        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='160' height='160'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.6' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='160' height='160' filter='url(%23n)' opacity='0.07'/%3E%3C/svg%3E");

        mix-blend-mode: soft-light;
        opacity: 0.25;
    }
    @media (max-width: 600px) {
        .rank-name {
            font-size:0.9rem;
            }
        .rank-score {
            font-size:1.5rem;
            }
        }

/* ================= PODIUM ================= */

.podium-wrapper {
    position: relative;
    display: flex;
    justify-content: center;
    margin-bottom: 4rem;
    padding-top: 3rem;
}

/* Spotlight */
.podium-spotlight {
    position: absolute;
    width: 520px;
    background: radial-gradient(
        ellipse at center,
        rgba(255,255,255,0.18),
        transparent 70%
    );
    top: 0;
    z-index: 0;
    filter: blur(12px);
}

.podium {
    display: flex;
    align-items: flex-end;
    gap: 2.5rem;
    z-index: 1;
}

.podium-spot {
    width: 300px;
    text-align: center;
    position: relative;
}

/* ================= MEDALS ================= */

.medal {
    font-size: 4rem;
    position: absolute;
    bottom:-40px;
    left: 50%;
    transform: translateX(-50%);
    filter: drop-shadow(0 6px 10px rgba(0,0,0,0.35));
}

.medal.gold {
    text-shadow: 0 0 18px rgba(255,215,0,0.9);
}

.medal.silver {
    text-shadow: 0 0 14px rgba(220,220,220,0.8);
}

.medal.bronze {
    text-shadow: 0 0 14px rgba(205,127,50,0.8);
}

/* ================= GLASS NAME CARD ================= */

.podium-card {
    background: color-mix(
        in srgb,
        var(--alabaster-grey) 20%,
        transparent
    );
    backdrop-filter: blur(1px);
    border-radius: 16px;
    padding: 0.8rem 1rem;
    margin-bottom: 0.8rem;
    border: 1px solid rgba(255,255,255,0.35);
    box-shadow:
        inset 0 1px 0 rgba(255,255,255,0.4),
        0 6px 16px rgba(0,0,0,0.25);
    align:center;
}

/* Winner gets subtle accent, not gold text */
.podium-card.winner {
    box-shadow:
        0 0 22px rgba(255,215,0,0.8),
        inset 0 1px 0 rgba(255,255,255,0.45);
}

/* Text uses ROOT COLORS */
.podium-name {
    font-weight: 1000;
    font-size: 1.6rem;
    color: var(--color-1);
}

.podium-score {
    font-size: 1.2rem;
    font-weight: 700;
    color: var(--color-3);
}

/* ================= PODIUM BLOCKS ================= */

.podium-block {
    width: 100%;
    border-radius: 22px 22px 0 0;
    box-shadow:
        inset 0 3px 0 rgba(255,255,255,0.35),
        0 14px 30px rgba(0,0,0,0.35);
}

/* ü•á GOLD */
.first .podium-block {
    height: 200px;
    background: linear-gradient(
        180deg,
        #FFD700,
        #C9A000
    );
}

/* ü•à SILVER */
.second .podium-block {
    height: 175px;
    background: linear-gradient(
        180deg,
        #E0E0E0,
        #A8A8A8
    );
}

/* ü•â BRONZE */
.third .podium-block {
    height: 150px;
    background: linear-gradient(
        180deg,
        #CD7F32,
        #9E5C26
    );
}

/* Lift the winner */
.podium-spot.first {
    transform: translateY(-26px);
}

/* ================= ENTRANCE ANIMATION ================= */

.podium-animate .podium-spot {
    animation: podiumRise 0.8s ease-out forwards;
    opacity: 0;
}

.podium-animate .first { animation-delay: 0.1s; }
.podium-animate .second { animation-delay: 0.25s; }
.podium-animate .third { animation-delay: 0.4s; }

@keyframes podiumRise {
    from {
        transform: translateY(40px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

/* ================= MOBILE ================= */

@media (max-width: 650px) {
    .podium {
        gap: 1.2rem;
    }

    .podium-spot {
        width: 100px;
    }

    .podium-name {
        font-size: 0.7rem;
    }

    .podium-score {
        font-size: 0.6rem;
    }
    .toggle-switch {
        width: 80%;
}


@media (max-width: 650px) {
    .ranking-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(110px, 3fr));
        gap: 0.1rem;
        width:105%;
    }

    .ranking-card {
        display: flex;                /* horizontal layout */
        flex-direction: row;          /* keep everything on one line */
        align-items: center;          /* vertically center items */
        justify-content: flex-start; /* align everything to left */
        padding: 0.1rem 0.2rem;
        border-radius: 12px;
        gap: 0.1rem;
    }

    .rank-position {
        font-size: 0.6rem;
        width: 15px;
        height: 15px;
        flex-shrink: 0;
        gap:0.1rem;
    }

    .rank-info {
        display: flex;
        align-items: left;
        justify-content: space-between;
        gap: 0.2rem;
        flex-grow: 1;
    }

    .rank-name {
        font-size: 0.5rem;
        padding: 0.1rem 0.3rem;
        white-space: nowrap;
    }

    .rank-score {
        font-size: 0.5rem;
        font-weight: 700;
    }

    .rank-info {
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 0.3rem;
    }
    /* ü•á GOLD */
    .first .podium-block {
        height: 100px;
    }

    /* ü•à SILVER */
    .second .podium-block {
        height: 75px;
    }

    /* ü•â BRONZE */
    .third .podium-block {
        height: 50px;
    }
    .medal {
        font-size:1.5rem;
        bottom:-20px;
    }
}



    </style>

    <!-- ================= DATA ================= -->
    <script>
    const SCORE_DETAILS = {{ score_details | tojson }};
    const CURRENT_USER_ID = {{ current_user_id }};
    </script>

    <!-- ================= SCRIPT ================= -->
    <script>


    const viewToggle = document.getElementById("viewToggle");

    viewToggle.addEventListener("change", () => {
        if (viewToggle.checked) {
            // Show Table, Hide Ranking
            rankingView.style.display = "none";
            tableView.style.display = "block";
        } else {
            // Show Ranking, Hide Table
            rankingView.style.display = "block";
            tableView.style.display = "none";
        }
    });


    // Modal logic
    const modal = document.getElementById("scoreModal");
    const modalTitle = document.getElementById("modalTitle");
    const modalBody = document.getElementById("modalBody");

    document.querySelectorAll(".score-cell").forEach(cell => {
        cell.addEventListener("click", () => {
            const userId = cell.dataset.userId;
            const eventId = cell.dataset.eventId;
            const score = cell.dataset.score;

            modalTitle.textContent = `${cell.dataset.user} ‚Äì ${cell.dataset.event}`;

            modalBody.innerHTML = "";
            const clickedRows = SCORE_DETAILS?.[userId]?.[eventId] || [];
            const currentRows = SCORE_DETAILS?.[CURRENT_USER_ID]?.[eventId] || [];
            const maxRows = Math.max(clickedRows.length, currentRows.length);

            for (let i = 0; i < maxRows; i++) {
                const clickedRow = clickedRows[i] || { rider: "-", position: "-", points: "-" };
                const currentRow = currentRows[i] || { rider: "-", position: "-", points: "-" };

                modalBody.innerHTML += `
                    <tr>
                        <td>${clickedRow.rider}</td>
                        <td>${clickedRow.position ?? "-"}</td>
                        <td><strong>${
                            clickedRow.points
                                ? `${clickedRow.points} (${clickedRow.base ?? "-"}*${clickedRow.captain ?? "-"}*${clickedRow.rarity ?? "-"})`
                                : "-"
                        }</strong></td>
                        <td>${currentRow.rider}</td>
                        <td>${currentRow.position ?? "-"}</td>
                        <td><strong>${
                            currentRow.points
                                ? `${currentRow.points} (${currentRow.base ?? "-"}*${currentRow.captain ?? "-"}*${currentRow.rarity ?? "-"})`
                                : "-"
                        }</strong></td>
                    </tr>
                `;

            }

            modal.style.display = "flex";
        });
    });

    document.querySelector(".modal-close").onclick = () => {
        modal.style.display = "none";
    };

    window.onclick = e => {
        if (e.target === modal) modal.style.display = "none";
    };
    </script>
<script>
function highlightEventWinners() {
    const table = document.querySelector(".leaderboard");
    if (!table) return;

    const rows = Array.from(table.querySelectorAll("tbody tr"));
    const headerCells = table.querySelectorAll("thead th");

    // Event columns start at index 2 (User, Total, then events)
    for (let colIndex = 2; colIndex < headerCells.length; colIndex++) {
        let maxScore = null;
        let cells = [];

        rows.forEach(row => {
            const cell = row.children[colIndex];
            const value = Number(cell.dataset.score);

            if (!isNaN(value)) {
                cells.push({ cell, value });
                if (maxScore === null || value > maxScore) {
                    maxScore = value;
                }
            }
        });

        // Highlight all max-score cells (handles ties)
        cells.forEach(({ cell, value }) => {
            if (value === maxScore && maxScore > 0) {
                cell.classList.add("event-winner");
            }
        });
    }
}

// Run on load
highlightEventWinners();
</script>

    {% endblock %}
