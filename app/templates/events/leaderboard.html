{% extends "base.html" %}
{% block content %}

<!-- Link your CSS palette -->

<h1 class="page-title">Leaderboard</h1>

<div style="display:flex; justify-content:space-between; align-items:center;">
    <h1 class="page-title">Leaderboard</h1>

    <a href="{{ url_for('admin.update_scores') }}"
       class="update-btn"
       onclick="return confirm('Recalculate all scores?');">
        üîÑ Update scores
    </a>
</div>

<!-- ================= TOGGLE ================= -->
<div class="view-toggle">
    <button id="rankingBtn" class="toggle-btn active">üèÜ Ranking</button>
    <button id="tableBtn" class="toggle-btn">üìä Detailed Score</button>
</div>

<!-- ================= RANKING VIEW ================= -->
<div id="rankingView">
    <div class="ranking-container">
        {% for user in user_scores %}
        <div class="ranking-card rank-{{ loop.index }}">
            <div class="rank-position">{{ loop.index }}</div>

            <div class="rank-info">
                <div class="rank-name">{{ user.username }}</div>
                <div class="rank-score">{{ user.total_score }} pts</div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- ================= FULL SCORE TABLE ================= -->
<div id="tableView" style="display:none">
<table class="leaderboard">
    <thead>
        <tr>
            <th>User</th>
            <th>Total</th>
            {% for event in events %}
                <th>{{ event.name }}</th>
            {% endfor %}
        </tr>
    </thead>
    <tbody>
        {% for user in user_scores %}
        <tr>
            <td>{{ user.username }}</td>
            <td class="total-cell">{{ user.total_score }}</td>

            {% for event in events %}
            <td class="score-cell"
                data-user-id="{{ user.id }}"
                data-event-id="{{ event.id }}"
                data-user="{{ user.username }}"
                data-event="{{ event.name }}"
                data-score="{{ user_event_scores[user.id][event.id] }}">
                {{ user_event_scores[user.id][event.id] }}
            </td>
            {% endfor %}
        </tr>
        {% endfor %}
    </tbody>
</table>
</div>

<!-- ================= MODAL ================= -->
<div id="scoreModal" class="modal">
  <div class="modal-content">
    <span class="modal-close">&times;</span>
    <h2 id="modalTitle"></h2>

    <table class="modal-table">
        <thead>
            <tr>
                <th colspan="3">Prediction</th>
                <th colspan="3">Your Data</th>
            </tr>
            <tr>
                <th>Rider</th>
                <th>Position</th>
                <th>Points</th>
                <th>Rider</th>
                <th>Position</th>
                <th>Points</th>
            </tr>
        </thead>
        <tbody id="modalBody"></tbody>
    </table>
  </div>
</div>

<!-- ================= STYLES ================= -->
<style>
/* Page Title */
.page-title {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 1rem;
    color: var(--color-1);
}

/* Toggle Buttons */
.view-toggle {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 2rem;
}

.toggle-btn {
    padding: 0.6rem 1.2rem;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-weight: 600;
    background: var(--color-2);
    color: var(--color-4);
    transition: all 0.2s ease;
}

.toggle-btn.active {
    background: var(--color-3);
    color: white;
}

/* Ranking */
.ranking-container {
    max-width: 600px;
    margin: 0 auto;
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.ranking-card {
    display: flex;
    align-items: center;
    background: var(--color-2);
    border-radius: 14px;
    padding: 1rem 1.5rem;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    transition: transform 0.2s;
}

.ranking-card:hover {
    transform: translateY(-2px);
}

.rank-position {
    font-size: 1.8rem;
    font-weight: 800;
    width: 60px;
    text-align: center;
}

.rank-1 .rank-position { color: #FFD700; } /* Gold */
.rank-2 .rank-position { color: #C0C0C0; } /* Silver */
.rank-3 .rank-position { color: #CD7F32; } /* Bronze */

.rank-info {
    display: flex;
    justify-content: space-between;
    width: 100%;
}

.rank-name {
    font-weight: 600;
    color: var(--color-5);
}

.rank-score {
    font-size: 1.2rem;
    font-weight: 700;
    color: var(--color-6);
}

/* Table */
table.leaderboard {
    width: 100%;
    border-collapse: collapse;
}

.leaderboard th,
.leaderboard td {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: center;
}

.leaderboard th {
    background: var(--color-3);
    color: white;
}

.score-cell {
    cursor: pointer;
    font-weight: 600;
}

.score-cell:hover {
    background: var(--color-2);
}

/* Modal */
.modal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.modal-content {
    background: var(--color-2);
    padding: 1.5rem;
    border-radius: 12px;
    width: 90%;
    max-width: 600px;
}

.modal-close {
    float: right;
    font-size: 1.4rem;
    cursor: pointer;
}

.modal-table {
    width: 100%;
    margin-top: 1rem;
    border-collapse: collapse;
}

.modal-table th,
.modal-table td {
    border: 1px solid #ddd;
    padding: 8px;
}

    .update-btn {
    padding: 0.6rem 1.2rem;
    border-radius: 8px;
    background: var(--color-6);
    color: white;
    font-weight: 600;
    text-decoration: none;
    transition: background 0.2s ease;
}

.update-btn:hover {
    background: var(--color-5);
}

</style>

<!-- ================= DATA ================= -->
<script>
const SCORE_DETAILS = {{ score_details | tojson }};
const CURRENT_USER_ID = {{ current_user_id }};
</script>

<!-- ================= SCRIPT ================= -->
<script>
// Toggle logic
const rankingBtn = document.getElementById("rankingBtn");
const tableBtn = document.getElementById("tableBtn");
const rankingView = document.getElementById("rankingView");
const tableView = document.getElementById("tableView");

rankingBtn.onclick = () => {
    rankingView.style.display = "block";
    tableView.style.display = "none";
    rankingBtn.classList.add("active");
    tableBtn.classList.remove("active");
};

tableBtn.onclick = () => {
    rankingView.style.display = "none";
    tableView.style.display = "block";
    tableBtn.classList.add("active");
    rankingBtn.classList.remove("active");
};

// Modal logic
const modal = document.getElementById("scoreModal");
const modalTitle = document.getElementById("modalTitle");
const modalBody = document.getElementById("modalBody");

document.querySelectorAll(".score-cell").forEach(cell => {
    cell.addEventListener("click", () => {
        const userId = cell.dataset.userId;
        const eventId = cell.dataset.eventId;
        const score = cell.dataset.score;

        modalTitle.textContent = `${cell.dataset.user} ‚Äì ${cell.dataset.event} (${score} pts)`;

        modalBody.innerHTML = "";
        const clickedRows = SCORE_DETAILS?.[userId]?.[eventId] || [];
        const currentRows = SCORE_DETAILS?.[CURRENT_USER_ID]?.[eventId] || [];
        const maxRows = Math.max(clickedRows.length, currentRows.length);

        for (let i = 0; i < maxRows; i++) {
            const clickedRow = clickedRows[i] || { rider: "-", position: "-", points: "-" };
            const currentRow = currentRows[i] || { rider: "-", position: "-", points: "-" };

            modalBody.innerHTML += `
                <tr>
                    <td>${clickedRow.rider}</td>
                    <td>${clickedRow.position ?? "-"}</td>
                    <td><strong>${clickedRow.points ?? "-"}</strong></td>
                    <td>${currentRow.rider}</td>
                    <td>${currentRow.position ?? "-"}</td>
                    <td><strong>${currentRow.points ?? "-"}</strong></td>
                </tr>
            `;
        }

        modal.style.display = "flex";
    });
});

document.querySelector(".modal-close").onclick = () => {
    modal.style.display = "none";
};

window.onclick = e => {
    if (e.target === modal) modal.style.display = "none";
};
</script>

{% endblock %}
