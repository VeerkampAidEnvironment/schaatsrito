{% extends "base.html" %}
{% block content %}
<!-- FlipDown Retro Flipping Countdown -->
<link rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/flipdown@0.3.2/dist/flipdown.min.css" />
<link rel="stylesheet"
      href="{{ url_for('static', filename='css/timeline.css') }}">

<script src="https://cdn.jsdelivr.net/npm/flipdown@0.3.2/dist/flipdown.min.js"></script>

<!-- Sticky Event Navigation Bar -->
<div class="event-nav-wrapper">

    <!-- Men -->
    <div class="event-gender-section">
        <div class="event-nav">
            <div class="gender-title">Vrouwen</div>
            {% for event in events %}
                {% set event_name, gender = event.name.rsplit(' ', 1) %}
                {% set gender = event.gender %}
                {% if gender == 'F' %}
                    <a href="#event-{{ event.id }}"
                       data-target="event-{{ event.id }}"
                       class="event-link
                       {% if event.start_datetime < now %}started
                       {% elif event.id in user_predictions %}predicted
                       {% else %}open
                       {% endif %}">
                        {% if event.start_datetime < now %}
                            ðŸ
                        {% elif event.id in user_predictions %}
                            âœ…
                        {% else %}
                            â³
                        {% endif %}
                        {{ event_name }}
                    </a>
                {% endif %}
            {% endfor %}
        </div>
    </div>

    <!-- Women -->
    <div class="event-gender-section">
        <div class="event-nav">
        <div class="gender-title">Mannen</div>
            {% for event in events %}
                {% set event_name, gender = event.name.rsplit(' ', 1) %}
                {% set gender = event.gender %}
                {% if gender == 'M' %}
                    <a href="#event-{{ event.id }}"
                       data-target="event-{{ event.id }}"
                       class="event-link
                       {% if event.start_datetime < now %}started
                       {% elif event.id in user_predictions %}predicted
                       {% else %}open
                       {% endif %}">
                        {% if event.start_datetime < now %}
                            ðŸ
                        {% elif event.id in user_predictions %}
                            âœ…
                        {% else %}
                            â³
                        {% endif %}
                        {{ event_name }}
                    </a>
                {% endif %}
            {% endfor %}
        </div>
    </div>

</div>


<div class="timeline">

    {% for event in events %}

    <div id="event-{{ event.id }}" class="timeline-item {% if loop.index is even %}right{% else %}left{% endif %}">

        <div class="timeline-content
            {% if event.id in user_predictions %} predicted
            {% elif event.start_datetime < now %} closed
            {% else %} open
            {% endif %}">

            <!-- Top row: Event name (left) & Gender (right) -->
            {% set event_name, gender = event.name.rsplit(' ', 1) %}
            {% set gender = event.gender %}
            <div class="card-header">
                <span class="event-name">{{ event_name }}</span>
                <span class="event-gender">{{ gender }}</span>
            </div>


            <div class="card-status-wrapper">
            <!-- Event status & timer -->
            <div class="card-status">
                {% if event.start_datetime < now %}
                    {% if event.results_final %}
                        <span class="status-text">Evenement afgelopen</span>
                    {% else %}
                        <span class="status-text">Evenement bezig</span>
                    {% endif %}
                {% else %}
                    <span class="countdown-timer timer"
                          data-start="{{ event.start_datetime.timestamp()|float }}"
                          data-now="{{ now.timestamp()|float }}"></span>
                {% endif %}
            </div>

            <!-- Prediction status -->
            {% if event.id in user_predictions %}
                {% if event.start_datetime > now %}
                <div class="card-prediction">
                    <span class="badge predicted">Voorspelling ingediend</span>
                </div>
                {% endif %}
            {% elif event.start_datetime >= now %}
                <div class="card-prediction">
                    <span class="badge open">Nog geen voorspelling</span>
                </div>
            {% endif %}
            </div>
            <!-- Action button -->
            <a class="btn {% if event.start_datetime < now %}result-btn{% else %}predict-btn{% endif %}"
               href="{{ url_for('events.event_detail', event_id=event.id) }}">
                {% if event.start_datetime < now %}
                    ðŸ Bekijk resultaat
                {% else %}

                {% if event.id in user_predictions %}
                    ðŸ–‰ï¸ Voorspelling aanpassen
                {% else %}
                    âœï¸ Voorspelling maken
                {% endif %}

                {% endif %}
            </a>
        </div>
                <!-- Timeline Dot / Date -->
        <div class="timeline-date {% if loop.index is even %}right{% else %}left{% endif %}" data-timestamp="{{ event.start_datetime.timestamp() }}">
            {{ event.start_datetime.strftime('%d %b - %H:%M') }}
        </div>
    </div>
    {% endfor %}
</div>

<script>
function initTimers() {
    const timers = document.querySelectorAll('.timer');

    timers.forEach(timerEl => {
        const startTime = new Date(parseFloat(timerEl.dataset.start) * 1000);
        let currentTime = new Date(parseFloat(timerEl.dataset.now) * 1000);

        function updateTimer() {
            let diff = startTime - currentTime;

            if (diff <= 0) {
                timerEl.textContent = "Evenement gestart!";
                return;
            }

            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            diff -= days * 1000 * 60 * 60 * 24;
            const hours = Math.floor(diff / (1000 * 60 * 60));
            diff -= hours * 1000 * 60 * 60;
            const minutes = Math.floor(diff / (1000 * 60));
            diff -= minutes * 1000 * 60;
            const seconds = Math.floor(diff / 1000);

            timerEl.textContent =
                (days > 0 ? days + "d " : "") +
                (hours < 10 ? "0" : "") + hours + "u " +
                (minutes < 10 ? "0" : "") + minutes + "m " +
                (seconds < 10 ? "0" : "") + seconds + "s";

            currentTime = new Date(currentTime.getTime() + 1000);
        }

        updateTimer();
        setInterval(updateTimer, 1000);
    });
}

document.addEventListener("DOMContentLoaded", initTimers);
</script>

<!-- Smooth Scroll Script for Navigation -->
<script>
document.querySelectorAll('.event-nav a').forEach(link => {
    link.addEventListener('click', function(e) {
        e.preventDefault();
        const targetId = this.getAttribute('href').substring(1);
        const targetEl = document.getElementById(targetId);
        targetEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
    });
});
</script>
<script>
document.addEventListener("DOMContentLoaded", () => {
    const links = document.querySelectorAll(".event-nav a");
    const sections = document.querySelectorAll(".timeline-item");

    const observer = new IntersectionObserver(
        entries => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const id = entry.target.id;
                    links.forEach(link => {
                        link.classList.toggle(
                            "active",
                            link.dataset.target === id
                        );
                    });
                }
            });
        },
        {
            rootMargin: "-40% 0px -50% 0px",
            threshold: 0
        }
    );

    sections.forEach(section => observer.observe(section));
});
</script>

<!-- Styles -->
<style>
/* Sticky navigation wrapper */
.event-nav-wrapper {
    position: sticky;
    top: 0;
    z-index: 1000;
    background: transparent;
    padding: 40px 0;
    width: 80%;
    display: grid;
    grid-template-columns: auto auto;
    margin:auto;
}

.event-nav {
    position: sticky;
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 6px;

    padding: 8px;
    margin: 0 auto;
    width: 80%;
    background: var(--color-2);
    border-radius: 50px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.25);
}


/* Individual event links */
.event-nav a {
    padding: 8px 14px;
    border-radius: 999px;
    font-size: 0.85rem;
    color: #ddd;
    text-decoration: none;
    white-space: nowrap;
    transition: all 0.25s ease;
}
.event-nav a.active {
    background: var(--color-2);
    color: #111;
    font-weight: 600;
    box-shadow: 0 0 0 2px rgba(255,255,255,0.15);
}

.event-nav a:hover {
    background: #007BFF;
    color: #fff;
    transform: translateY(-2px);
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}

/* Events that already started */
.event-nav a.started {
    background: red;
    color: #fff;
}

/* Events with prediction submitted */
.event-nav a.predicted {
    background: var(--color-5);
    color: #fff;
}

/* Events open for prediction */
.event-nav a.open {
    background: var(--color-1);
    color: #fff;
}

/* Hover polish */
.event-nav a.started:hover,
.event-nav a.predicted:hover,
.event-nav a.open:hover {
    filter: brightness(1.1);
    transform: translateY(-2px);
}

/* Timeline spacing so nav doesnâ€™t overlap */
.timeline {
    margin-top: 15px;
}

/* Optional: highlight active event link when scrolled */
.event-nav a.active {
    background: #007BFF;
    color: #fff;
}

@media (max-width: 768px) {
    /* Hide entire event navigation on mobile */
    .event-nav-wrapper {
        display: none;
    }

}

@media (max-width: 768px) {

    /* Timeline container */
    .timeline {
        width: 100%;
        padding: 20px 12px;
    }

    /* Remove center line */
    .timeline::before {
        display: none;
    }

    /* Full-width items */
    .timeline-item {
        width: 100%;
        padding: 10px 0;
        left: 0 !important;
        margin-top: 0 !important;
    }

    /* Disable stagger offsets */
    .timeline-item.right:nth-of-type(2n),
    .timeline-item.left:nth-of-type(2n+1) {
        margin-top: 0;
    }

    /* Timeline cards */
    .timeline-content {
        padding: 16px;
        border-radius: 12px;
    }
}

@media (max-width: 768px) {

    .timeline-date {
        position: relative;
        top: auto;
        left: auto !important;
        right: auto !important;

        margin: 8px auto 0;
        width: auto;
        height: auto;
        border-radius: 999px;
        padding: 6px 12px;

        font-size: 0.75rem;
        text-align: center;
    }
}

@media (max-width: 768px) {

    .card-header {
        flex-direction: column;
        align-items: center;
        gap: 4px;
        text-align: center;
    }

    .event-name {
        font-size: 1.4rem;
        max-width: 100%;
        white-space: normal;
    }

    .event-gender {
        font-size: 0.9rem;
        opacity: 0.8;
    }
}
@media (max-width: 768px) {

    .card-status-wrapper {
        flex-direction: column;
        align-items: center;
        gap: 10px;
    }

    .countdown-timer {
        font-size: 0.85rem;
    }
}

@media (max-width: 768px) {

    .btn {
        width: 100%;
        padding: 14px;
        font-size: 1rem;
        border-radius: 999px;
    }
}

@media (max-width: 768px) {

    .event-nav-wrapper {
        padding: 10px 0;
    }

    .event-nav {
        flex-wrap: nowrap;
        overflow-x: auto;
        justify-content: flex-start;
        padding: 8px 10px;
        gap: 8px;
        scrollbar-width: none;
    }

    .event-nav::-webkit-scrollbar {
        display: none;
    }

    .event-nav a {
        flex: 0 0 auto;
        font-size: 0.8rem;
        padding: 6px 12px;
    }

    .gender-title {
        font-size: 1rem;
        margin: 6px 0;
        border-width: 3px;
    }
}
.timeline-item {
    scroll-margin-top: 140px;
}

@media (max-width: 768px) {
    .timeline-item {
        scroll-margin-top: 180px;
    }
}

</style>

{% endblock %}
